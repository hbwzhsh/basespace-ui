{% extends 'common/base.html' %} {% block header %} {% endblock %} {% block content %}

<script type="text/javascript">

//refresh job list

 $(document).ready(function() {
 	 $("#joblist_container").load("/peakAnalyzer/jobserver-regular/{{ user.id }}/listjob");
   var secs=60000*3
   var refreshId = setInterval(function() {
      $("#joblist_container").load("/peakAnalyzer/jobserver-regular/{{ user.id }}/listjob");
   }, secs);
   $.ajaxSetup({ cache: false });
});

//Refresh table on click
function refresh_table(){
     $("#joblist_container").load("/peakAnalyzer/jobserver-regular/{{ user.id }}/listjob");
}



function listUploaded(filetype)
{
$.ajax({   
        type: "GET",
        url: "/peakAnalyzer/regular/listUploadedFiles",    
        dataType:'json',   
        success: function(data, textStatus){
        		var filelist=""
        		$(data[filetype]).each(function(index){
        			var filename=data[filetype][index];
        			//check if uploaded file is from basespace
        			var splitOut = filename.split("__");
        			var fname=filename;
        			if(splitOut.length>1) {
        				fid=splitOut[0]
  						fname="file__" + fid;
  						filename=fid+"_" + splitOut[1];
       				}
       
        		 	var file='<li id='+ fname +' onclick="add_list(this)">' + filename+'</li>';
     				filelist=filelist+file;
     				
        });
        		
				$("#"+filetype).html(filelist);        	
	}})
}

$("#icon-toggle").click(function(){
$("i #closedfolder").toggle(
function(){
	$(this).class="icon-folder-open";
},
function(){
	$(this).class="icon-folder-close";
}
);
});



addedFiles={};
function add_list(trigger_obj)
{
var name=trigger_obj.innerHTML
if(!addedFiles.hasOwnProperty(name))
{
var fid=trigger_obj.id.split("__")[1]

if (fid){
var html="<tr><td>\
<select id=cb__"+fid+" name=cb__"+fid+"> \
  <option>Sample</option> \
  <option>Control</option>\
  <option>Delete</option>\
 </select>\
 </td><td>"+name+"</td></tr>";
 }else{
 var html="<tr id="+"row_"+name+"><td>\
<select id=up__"+name+" name=up__"+name+"> \
  <option>Sample</option> \
  <option>Control</option>\
 </select>\
 </td><td>"+name+"</td>\
 <td style='border-left:0px;text-align:right;'><i id='del_"+name+"' class='icon-remove' onclick='deleteFromJobTable(this)'></i></td></tr>";
 }
     $("#datalists").append(html);
     $("#inputGenome").attr("placeholder",trigger_obj.getAttribute('genome'));
     addedFiles[name]=true;
     console.log(JSON.stringify(addedFiles));
}
}

 function deleteFromJobTable(element){
 	var name=element.id.split("del_")[1];
  	var row=document.getElementById("row_"+name);
 	row.parentNode.removeChild(row);
 	delete addedFiles[name]; 	
 }
 
function test()
{
 var postdata = "";
 var ctrl_ids="";
 var sample_ids="";
 $("*[name*='cb__']").each(function(i) {
                if ($(this).val() =="Control") {
                        line = $(this).attr("name");
                        ctrl_ids += line.split("__")[1] + ',';
                }
                else if($(this).val() =="Sample") 
                {
                	 line = $(this).attr("name");
                        sample_ids += line.split("__")[1] + ',';
                }
        });
postdata+='ctrl_ids='+ctrl_ids;
postdata+='&sample_ids='+sample_ids;
postdata+='&inputTitle='+$('#inputTitle').val() ;
postdata+='&inputGenome='+$('#inputGenome').val() ;    
window.alert(postdata);

}

function submit_job()
{

 var postdata = "";
 var ctrl_ids="";
 var sample_ids="";
 $("*[name*='cb__'],*[name*='up__'] ").each(function(i) {
                if ($(this).val() =="Control") {
                        line = $(this).attr("name");
                        ctrl_ids += line.split("__")[1] + ',';
                }
                else if($(this).val() =="Sample") 
                {
                	 line = $(this).attr("name");
                        sample_ids += line.split("__")[1] + ',';
                }
        });
postdata+='ctrl_ids='+ctrl_ids;
postdata+='&sample_ids='+sample_ids;
postdata+='&inputTitle='+$('#inputTitle').val() ;
postdata+='&inputGenome='+$('#inputGenome').val() ;    
postdata+='&inputCell='+$('#inputCell').val() ;   


		$.ajax({   
        type: "POST",
        url: "/peakAnalyzer/regular/submitJob/", 
        data: postdata,      
        dataType:'text',   
        success: function(data, textStatus){
        		window.alert(data);
        		$("#joblist_container").load("/peakAnalyzer/jobserver-regular/{{ user.id }}/listjob");
		}
	})
}



</script>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
<script src="/../peakAnalyzer/static/fileUpload/js/vendor/jquery.ui.widget.js"></script>
<script src="/../peakAnalyzer/static/fileUpload/js/jquery.iframe-transport.js"></script>
<script src="/../peakAnalyzer/static/fileUpload/js/jquery.fileupload.js"></script>
        
 <script>
$(function () {
    $('#fileupload').fileupload({
        dataType: 'json',
       add: function (e, data) {
        
        $.each(data.files, function (index, file) {

                var row =$('<tr id=tr_' +file.name +'/>');
                 $('<td id="td_' + file.name+ '" class="name"/>').text(file.name).appendTo(row);
 
                var button=$('<td class="cancel"> <button type="reset" id="button.cancel_'+ file.name+'" class="btn btn-warning cancel"><i class="icon-ban-circle icon-white"></i></button></td>');
                button.appendTo(row);
               
                row.appendTo($("#localfile_list table"));
		});
        
        var jqXHR = data.submit()
            .success(function (result, textStatus, jqXHR) {/* ... */})
            .error(function (jqXHR, textStatus, errorThrown) {
            if (errorThrown === 'abort') {
            alert('File Upload has been canceled');
        	}
            })
            .complete(function (result, textStatus, jqXHR) {/* ... */});
            
       	$('button.cancel').click(function (e) {
    		jqXHR.abort();

		});
            
    
        },
         done: function (e, data) {
           $.each(data.result.files, function (index, file) {
         //       $('<p/>').text(file.name).appendTo($("#localfile_list"));
         	 alert(file.name + " uploaded!");
         	 var test= document.getElementById("tr_" + file.name);
         	 //alert();
         	 $('button #button.cancel_' + file.name).hide();
            });
           
            
        }
      
    });
});
/*
$('#localfile_list table tr').live("click",function()
{

var filename = $(this).text(); 
var trigger = document.createElement("div");
trigger.innerHTML = filename;
add_list(trigger);
});
*/
     </script> 
<head>
<!-- Generic page styles -->
<!-- CSS to style the file input field as button and adjust the Bootstrap progress bars -->
<link rel="stylesheet" href="/../peakAnalyzer/static/fileUpload/css/jquery.fileupload-ui.css">
<!-- CSS adjustments for browsers with JavaScript disabled -->
<noscript><link rel="stylesheet" href="/../peakAnalyzer/static/fileUpload/css/jquery.fileupload-ui-noscript.css"></noscript>
             
               
</head>
  
<div class="row-fluid">

<div class="span3">
<li class="nav-header"><a href="#"><i
class="icon-home icon-white"></i> <i class="icon-user"></i>{{ user.username }}</a>
</li>
          <div class="well sidebar-nav">
            <ul class="nav nav-list">
{% for project in projects_list %}
	<li class="nav-header"><i class="icon-book"></i>{{ project.Name }}</li>
	 <hr>Local Files</hr>
	 <div id="localfile_list">
<!-- 
<span class="btn btn-success fileinput-button">
                    <i class="icon-plus icon-white"></i>
                    <span>Add files...</span>
<input id="fileupload" type="file" name="files[]" data-url="/peakAnalyzer/regular/uploadFiles/" multiple>
</span>
<br>
-->

<div class="fileupload-loading"></div>
    <a href="#modal_table" role="button" class="btn btn-success" data-toggle="modal">Upload Files <i class="icon-arrow-up icon-white"></i></a>

	<div id="modal_table" class="modal hide fade" style="width:800; margin:0 0 0 -400px;">
	<div class="modal-header">
		<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
		<h3>Upload Files </h3>
	</div>
	<div class="modal-body">
    <!-- The file upload form used as target for the file upload widget -->
    <form id="fileupload" action="/peakAnalyzer/regular/uploadFiles/" method="POST" enctype="multipart/form-data">
        <!-- Redirect browsers with JavaScript disabled to the origin page -->
        <noscript><input type="hidden" name="redirect" value="http://blueimp.github.com/jQuery-File-Upload/"></noscript>
        <!-- The fileupload-buttonbar contains buttons to add/delete files and start/cancel the upload -->
        <div  class="row fileupload-buttonbar">
            <div class="span7">
                <!-- The fileinput-button span is used to style the file input field as button -->
                <span class="btn btn-success fileinput-button">
                    <i class="icon-plus icon-white"></i>
                    <span>Add files...</span>
                    <input type="file" name="files[]" multiple>
                </span>
                <button type="submit" class="btn btn-primary start">
                    <i class="icon-upload icon-white"></i>
                    <span>Start upload</span>
                </button>
                <button type="reset" class="btn btn-warning cancel">
                    <i class="icon-ban-circle icon-white"></i>
                    <span>Cancel upload</span>
                </button>
                <button type="button" class="btn btn-danger delete">
                    <i class="icon-trash icon-white"></i>
                    <span>Delete</span>
                </button>
                <input type="checkbox" class="toggle">
            </div>
            <!-- The global progress information -->
	    <div class="span5 fileupload-progress fade">
                <!-- The global progress bar -->
                <div class="progress progress-success progress-striped active" role="progressbar" aria-valuemin="0" aria-valuemax="100">
                    <div class="bar" style="width:0%;"></div>
                </div>
                <!-- The extended global progress information -->
                <div class="progress-extended">&nbsp;</div>
            </div>
        </div>
        <!-- The loading indicator is shown during file processing -->
        <!-- The table listing the files available for upload/download -->
        <table role="presentation" class="table table-striped"><tbody class="files"></tbody></table>
</div>
</div>
</form>
   

<!-- The template to display files available for upload -->

<script id="template-upload" type="text/x-tmpl">


	{% for (var i=0, file; file=o.files[i]; i++) { %}
    <tr class="template-upload fade">
        <td class="name"><span>{%=file.name%}</span></td>
        <td class="size"><span>{%=o.formatFileSize(file.size)%}</span></td>
        {% if (file.error) { %}
            <td class="error" colspan="2"><span class="label label-important">Error</span> {%=file.error%}</td>
        {% } else if (o.files.valid && !i) { %}
            <td>
                <div class="progress progress-success progress-striped active" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0"><div class="bar" style="width:0%;"></div></div>
            </td>
            <td class="start">{% if (!o.options.autoUpload) { %}
                <button class="btn btn-primary">
                    <i class="icon-upload icon-white"></i>
                    <span>Start</span>
                </button>
            {% } %}</td>
        {% } else { %}
            <td colspan="2"></td>
        {% } %}
        <td class="cancel">{% if (!i) { %}
            <button class="btn btn-warning">
                <i class="icon-ban-circle icon-white"></i>
                <span>Cancel</span>
            </button>
        {% } %}</td>
    </tr>
    {% } %}


</script>
<!-- The template to display files available for download -->
<script id="template-download" type="text/x-tmpl">
{% for (var i=0, file; file=o.files[i]; i++) { %}
    <tr class="template-download fade">
        {% if (file.error) { %}
            <td></td>
            <td class="name"><span>{%=file.name%}</span></td>
            <td class="size"><span>{%=o.formatFileSize(file.size)%}</span></td>
            <td class="error" colspan="2"><span class="label label-important">Error</span> {%=file.error%}</td>
        {% } else { %}
            <td class="name">
		    <span> {%=file.name%}</span>
            </td>
            <td class="size"><span>{%=o.formatFileSize(file.size)%}</span></td>
            <td colspan="2"></td>
        {% } %}
        <td class="delete">
            <button class="btn btn-danger" data-type="{%=file.delete_type%}" data-url="{%=file.delete_url%}"{% if (file.delete_with_credentials) { %} data-xhr-fields='{"withCredentials":true}'{% } %}>
                <i class="icon-trash icon-white"></i>
                <span>Delete</span>
            </button>
            <input type="checkbox" name="delete" value="1">
        </td>
    </tr>
{% } %}
</script>

<!-- The Templates plugin is included to render the upload/download listings -->
<script src="http://blueimp.github.com/JavaScript-Templates/tmpl.min.js"></script>
<!-- The Load Image plugin is included for the preview images and image resizing functionality -->
<script src="http://blueimp.github.com/JavaScript-Load-Image/load-image.min.js"></script>
<!-- The Canvas to Blob plugin is included for image resizing functionality -->
<script src="http://blueimp.github.com/JavaScript-Canvas-to-Blob/canvas-to-blob.min.js"></script>
<script src="http://blueimp.github.com/Bootstrap-Image-Gallery/js/bootstrap-image-gallery.min.js"></script>
<!-- The Iframe Transport is required for browsers without support for XHR file uploads -->
<script src="js/jquery.iframe-transport.js"></script>
<!-- The basic File Upload plugin -->
<script src="/../peakAnalyzer/static/fileUpload/js/jquery.fileupload.js"></script>
<!-- The File Upload file processing plugin -->
<script src="/../peakAnalyzer/static/fileUpload/js/jquery.fileupload-fp.js"></script>
<!-- The File Upload user interface plugin -->
<script src="/../peakAnalyzer/static/fileUpload/js/jquery.fileupload-ui.js"></script>
<!-- The main application script -->
<script src="/../peakAnalyzer/static/fileUpload/js/main.js"></script	>
<!-- The XDomainRequest Transport is included for cross-domain file deletion for IE8+ -->
<!--[if gte IE 8]><script src="js/cors/jquery.xdr-transport.js"></script><![endif]-->

  
                </div> 
                <!-- end of file upload div -->
      <hr>Uploaded Files</hr>   
      <div id=uploadedfile_list>
      
      <script>
      filetypes=["bed","bam", "sam","fasta", "fastq"];
      for(var i=0; i<filetypes.length; i++)
      {
      document.write('<li><a id="icon-toggle" class="accordion-toggle" data-toggle="collapse" data-target="#' + filetypes[i] + '" href="#' + filetypes[i] + '" onclick=listUploaded("' +filetypes[i]+ '") ><i id="closedfolder" class="icon-folder-close"></i>' + filetypes[i] + '</a></li>');
      document.write("<div id="+ filetypes[i]+ " class='collapse' > Loading..</div>");
      }
      
      </script>
     
	  </div>
	
{% endfor %}
            </ul>
          </div><!--/.well -->
        </div><!--/span-->
        
 <div class="span9" style="padding-top:25px">
         
          <form class="form-horizontal" id="form_jobdata" >
          <table  class="table table-bordered" id=datalists>
          <tr><td> <label class="control-label" for="inputTitle">Job Title</label> </td> <td colspan="2"><input type="text" id="inputTitle" name="inputTitle" placeholder="Job Title"></td></tr>
         <tr><td> <label class="control-label" for="inputGenome">Reference Genome</label> </td> <td colspan="2"><input type="text" id="inputGenome" name="inputGenome" placeholder="{{genome_names}}"></td></tr>
         <tr><td> <label class="control-label" for="inputCell">Cell Type</label> </td> <td colspan="2"><input type="text" id="inputCell" name="inputCell" placeholder="cell"></td></tr>
         
         <tr><td>Data Type</td><td colspan="2">File Name</td></tr>
          
          </table>
        
	   <button class="btn btn-danger" type="button" onclick="submit_job()">Submit Job</button>
          </form>
	  
          
  </div><!--/span-->
  
   <div class="span9" id="joblist_container">
   
   </div>
 </div><!--/row-->
 
{% block modal %}
{% endblock %}

{% endblock %}
